function e(){return(e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)({}).hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(null,arguments)}var t=new Blob(['\n      const BIAS = 0x84;\n      const CLIP = 32635;\n      const encodeTable = [\n        0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,\n        4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,\n        5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n        5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,\n        6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n        6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n        6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n        6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,\n        7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n        7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n        7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n        7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n        7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n        7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n        7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,\n        7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7\n      ];\n      \n      function encodeSample(sample) {\n        let sign;\n        let exponent;\n        let mantissa;\n        let muLawSample;\n        sign = (sample >> 8) & 0x80;\n        if (sign !== 0) sample = -sample;\n        sample = sample + BIAS;\n        if (sample > CLIP) sample = CLIP;\n        exponent = encodeTable[(sample>>7) & 0xFF];\n        mantissa = (sample >> (exponent+3)) & 0x0F;\n        muLawSample = ~(sign | (exponent << 4) | mantissa);\n        \n        return muLawSample;\n      }\n    \n      class RawAudioProcessor extends AudioWorkletProcessor {\n        constructor() {\n          super();\n                    \n          this.port.onmessage = ({ data }) => {\n            switch (data.type) {\n              case "setFormat":\n                this.isMuted = false;\n                this.buffer = []; // Initialize an empty buffer\n                this.bufferSize = data.sampleRate / 4;\n                this.format = data.format;\n\n                if (globalThis.LibSampleRate && sampleRate !== data.sampleRate) {\n                  globalThis.LibSampleRate.create(1, sampleRate, data.sampleRate).then(resampler => {\n                    this.resampler = resampler;\n                  });\n                }\n                break;\n              case "setMuted":\n                this.isMuted = data.isMuted;\n                break;\n            }\n          };\n        }\n        process(inputs) {\n          if (!this.buffer) {\n            return true;\n          }\n          \n          const input = inputs[0]; // Get the first input node\n          if (input.length > 0) {\n            let channelData = input[0]; // Get the first channel\'s data\n\n            // Resample the audio if necessary\n            if (this.resampler) {\n              channelData = this.resampler.full(channelData);\n            }\n\n            // Add channel data to the buffer\n            this.buffer.push(...channelData);\n            // Get max volume \n            let sum = 0.0;\n            for (let i = 0; i < channelData.length; i++) {\n              sum += channelData[i] * channelData[i];\n            }\n            const maxVolume = Math.sqrt(sum / channelData.length);\n            // Check if buffer size has reached or exceeded the threshold\n            if (this.buffer.length >= this.bufferSize) {\n              const float32Array = this.isMuted \n                ? new Float32Array(this.buffer.length)\n                : new Float32Array(this.buffer);\n\n              let encodedArray = this.format === "ulaw"\n                ? new Uint8Array(float32Array.length)\n                : new Int16Array(float32Array.length);\n\n              // Iterate through the Float32Array and convert each sample to PCM16\n              for (let i = 0; i < float32Array.length; i++) {\n                // Clamp the value to the range [-1, 1]\n                let sample = Math.max(-1, Math.min(1, float32Array[i]));\n\n                // Scale the sample to the range [-32768, 32767]\n                let value = sample < 0 ? sample * 32768 : sample * 32767;\n                if (this.format === "ulaw") {\n                  value = encodeSample(Math.round(value));\n                }\n\n                encodedArray[i] = value;\n              }\n\n              // Send the buffered data to the main script\n              this.port.postMessage([encodedArray, maxVolume]);\n\n              // Clear the buffer after sending\n              this.buffer = [];\n            }\n          }\n          return true; // Continue processing\n        }\n      }\n      registerProcessor("raw-audio-processor", RawAudioProcessor);\n  '],{type:"application/javascript"}),n=URL.createObjectURL(t);function o(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}var i=function(){function e(e,t,n,o){this.context=void 0,this.analyser=void 0,this.worklet=void 0,this.inputStream=void 0,this.context=e,this.analyser=t,this.worklet=n,this.inputStream=o}e.create=function(t){var i=t.sampleRate,a=t.format,s=t.preferHeadphonesForIosDevices;try{var r=null,l=null;return Promise.resolve(function(t,u){try{var c=function(){function t(){function t(){return Promise.resolve(r.audioWorklet.addModule(n)).then(function(){return Promise.resolve(navigator.mediaDevices.getUserMedia({audio:u})).then(function(t){var n=r.createMediaStreamSource(l=t),o=new AudioWorkletNode(r,"raw-audio-processor");return o.port.postMessage({type:"setFormat",format:a,sampleRate:i}),n.connect(s),s.connect(o),Promise.resolve(r.resume()).then(function(){return new e(r,s,o,l)})})})}var o=navigator.mediaDevices.getSupportedConstraints().sampleRate,s=(r=new window.AudioContext(o?{sampleRate:i}:{})).createAnalyser(),c=function(){if(!o)return Promise.resolve(r.audioWorklet.addModule("https://cdn.jsdelivr.net/npm/@alexanderolsen/libsamplerate-js@2.1.2/dist/libsamplerate.worklet.js")).then(function(){})}();return c&&c.then?c.then(t):t()}var u={sampleRate:{ideal:i},echoCancellation:{ideal:!0},noiseSuppression:{ideal:!0}},c=function(){if(o()&&s)return Promise.resolve(window.navigator.mediaDevices.enumerateDevices()).then(function(e){var t=e.find(function(e){return"audioinput"===e.kind&&["airpod","headphone","earphone"].find(function(t){return e.label.toLowerCase().includes(t)})});t&&(u.deviceId={ideal:t.deviceId})})}();return c&&c.then?c.then(t):t()}()}catch(e){return u(e)}return c&&c.then?c.then(void 0,u):c}(0,function(e){var t,n;throw null==(t=l)||t.getTracks().forEach(function(e){return e.stop()}),null==(n=r)||n.close(),e}))}catch(e){return Promise.reject(e)}};var t=e.prototype;return t.close=function(){try{return this.inputStream.getTracks().forEach(function(e){return e.stop()}),Promise.resolve(this.context.close()).then(function(){})}catch(e){return Promise.reject(e)}},t.setMuted=function(e){this.worklet.port.postMessage({type:"setMuted",isMuted:e})},e}(),a=new Blob(['\n      const decodeTable = [0,132,396,924,1980,4092,8316,16764];\n      \n      export function decodeSample(muLawSample) {\n        let sign;\n        let exponent;\n        let mantissa;\n        let sample;\n        muLawSample = ~muLawSample;\n        sign = (muLawSample & 0x80);\n        exponent = (muLawSample >> 4) & 0x07;\n        mantissa = muLawSample & 0x0F;\n        sample = decodeTable[exponent] + (mantissa << (exponent+3));\n        if (sign !== 0) sample = -sample;\n\n        return sample;\n      }\n      \n      class AudioConcatProcessor extends AudioWorkletProcessor {\n        constructor() {\n          super();\n          this.buffers = []; // Initialize an empty buffer\n          this.cursor = 0;\n          this.currentBuffer = null;\n          this.wasInterrupted = false;\n          this.finished = false;\n          \n          this.port.onmessage = ({ data }) => {\n            switch (data.type) {\n              case "setFormat":\n                this.format = data.format;\n                break;\n              case "buffer":\n                this.wasInterrupted = false;\n                this.buffers.push(\n                  this.format === "ulaw"\n                    ? new Uint8Array(data.buffer)\n                    : new Int16Array(data.buffer)\n                );\n                break;\n              case "interrupt":\n                this.wasInterrupted = true;\n                break;\n              case "clearInterrupted":\n                if (this.wasInterrupted) {\n                  this.wasInterrupted = false;\n                  this.buffers = [];\n                  this.currentBuffer = null;\n                }\n            }\n          };\n        }\n        process(_, outputs) {\n          let finished = false;\n          const output = outputs[0][0];\n          for (let i = 0; i < output.length; i++) {\n            if (!this.currentBuffer) {\n              if (this.buffers.length === 0) {\n                finished = true;\n                break;\n              }\n              this.currentBuffer = this.buffers.shift();\n              this.cursor = 0;\n            }\n\n            let value = this.currentBuffer[this.cursor];\n            if (this.format === "ulaw") {\n              value = decodeSample(value);\n            }\n            output[i] = value / 32768;\n            this.cursor++;\n\n            if (this.cursor >= this.currentBuffer.length) {\n              this.currentBuffer = null;\n            }\n          }\n\n          if (this.finished !== finished) {\n            this.finished = finished;\n            this.port.postMessage({ type: "process", finished });\n          }\n\n          return true; // Continue processing\n        }\n      }\n\n      registerProcessor("audio-concat-processor", AudioConcatProcessor);\n    '],{type:"application/javascript"}),s=URL.createObjectURL(a),r=function(){function e(e,t,n,o){this.context=void 0,this.analyser=void 0,this.gain=void 0,this.worklet=void 0,this.context=e,this.analyser=t,this.gain=n,this.worklet=o}return e.create=function(t){var n=t.sampleRate,o=t.format;try{var i=null;return Promise.resolve(function(t,a){try{var r,l,u=(r=(i=new AudioContext({sampleRate:n})).createAnalyser(),(l=i.createGain()).connect(r),r.connect(i.destination),Promise.resolve(i.audioWorklet.addModule(s)).then(function(){var t=new AudioWorkletNode(i,"audio-concat-processor");return t.port.postMessage({type:"setFormat",format:o}),t.connect(l),Promise.resolve(i.resume()).then(function(){return new e(i,r,l,t)})}))}catch(e){return a(e)}return u&&u.then?u.then(void 0,a):u}(0,function(e){var t;throw null==(t=i)||t.close(),e}))}catch(e){return Promise.reject(e)}},e.prototype.close=function(){try{return Promise.resolve(this.context.close()).then(function(){})}catch(e){return Promise.reject(e)}},e}(),l=function(){function e(e,t,n,o){var i=this;this.socket=void 0,this.conversationId=void 0,this.inputFormat=void 0,this.outputFormat=void 0,this.queue=[],this.disconnectionDetails=null,this.onDisconnectCallback=null,this.onMessageCallback=null,this.socket=e,this.conversationId=t,this.inputFormat=n,this.outputFormat=o,this.socket.addEventListener("error",function(e){setTimeout(function(){return i.disconnect({reason:"error",message:"The connection was closed due to a socket error.",context:e})},0)}),this.socket.addEventListener("close",function(e){i.disconnect(1e3===e.code?{reason:"agent",context:e}:{reason:"error",message:e.reason||"The connection was closed by the server.",context:e})}),this.socket.addEventListener("message",function(e){try{var t=JSON.parse(e.data);if(!t.type)return;i.onMessageCallback?i.onMessageCallback(t):i.queue.push(t)}catch(e){}})}e.create=function(t){try{var n=null;return Promise.resolve(function(o,i){try{var a,s,r,l,c=(s=null!=(a=t.origin)?a:"wss://api.elevenlabs.io",r=t.signedUrl?t.signedUrl:s+"/v1/convai/conversation?agent_id="+t.agentId,l=["convai"],t.authorization&&l.push("bearer."+t.authorization),n=new WebSocket(r,l),Promise.resolve(new Promise(function(e,o){n.addEventListener("open",function(){var e,o,i,a,s,r={type:"conversation_initiation_client_data"};t.overrides&&(r.conversation_config_override={agent:{prompt:null==(o=t.overrides.agent)?void 0:o.prompt,first_message:null==(i=t.overrides.agent)?void 0:i.firstMessage,language:null==(a=t.overrides.agent)?void 0:a.language},tts:{voice_id:null==(s=t.overrides.tts)?void 0:s.voiceId}}),t.customLlmExtraBody&&(r.custom_llm_extra_body=t.customLlmExtraBody),t.dynamicVariables&&(r.dynamic_variables=t.dynamicVariables),null==(e=n)||e.send(JSON.stringify(r))},{once:!0}),n.addEventListener("error",function(e){setTimeout(function(){return o(e)},0)}),n.addEventListener("close",o),n.addEventListener("message",function(t){var n=JSON.parse(t.data);n.type&&("conversation_initiation_metadata"===n.type?e(n.conversation_initiation_metadata_event):console.warn("First received message is not conversation metadata."))},{once:!0})})).then(function(t){var o=t.conversation_id,i=t.agent_output_audio_format,a=t.user_input_audio_format,s=u(null!=a?a:"pcm_16000"),r=u(i);return new e(n,o,s,r)}))}catch(e){return i(e)}return c&&c.then?c.then(void 0,i):c}(0,function(e){var t;throw null==(t=n)||t.close(),e}))}catch(e){return Promise.reject(e)}};var t=e.prototype;return t.close=function(){this.socket.close()},t.sendMessage=function(e){this.socket.send(JSON.stringify(e))},t.onMessage=function(e){this.onMessageCallback=e,this.queue.forEach(e),this.queue=[]},t.onDisconnect=function(e){this.onDisconnectCallback=e,this.disconnectionDetails&&e(this.disconnectionDetails)},t.disconnect=function(e){var t;this.disconnectionDetails||(this.disconnectionDetails=e,null==(t=this.onDisconnectCallback)||t.call(this,e))},e}();function u(e){var t=e.split("_"),n=t[0],o=t[1];if(!["pcm","ulaw"].includes(n))throw Error("Invalid format: "+e);var i=parseInt(o);if(isNaN(i))throw Error("Invalid sample rate: "+o);return{format:n,sampleRate:i}}function c(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var d={clientTools:{}},m={onConnect:function(){},onDebug:function(){},onDisconnect:function(){},onError:function(){},onMessage:function(){},onAudio:function(){},onModeChange:function(){},onStatusChange:function(){},onCanSendFeedbackChange:function(){}},h=function(){function t(e,t,n,o,i){var a=this,s=this,r=this;this.options=void 0,this.connection=void 0,this.input=void 0,this.output=void 0,this.wakeLock=void 0,this.lastInterruptTimestamp=0,this.mode="listening",this.status="connecting",this.inputFrequencyData=void 0,this.outputFrequencyData=void 0,this.volume=1,this.currentEventId=1,this.lastFeedbackEventId=1,this.canSendFeedback=!1,this.endSession=function(){return r.endSessionWithDetails({reason:"user"})},this.endSessionWithDetails=function(e){try{var t=function(){return a.connection.close(),Promise.resolve(a.input.close()).then(function(){return Promise.resolve(a.output.close()).then(function(){a.updateStatus("disconnected"),a.options.onDisconnect(e)})})};if("connected"!==a.status&&"connecting"!==a.status)return Promise.resolve();a.updateStatus("disconnecting");var n=c(function(){var e;return Promise.resolve(null==(e=a.wakeLock)?void 0:e.release()).then(function(){a.wakeLock=null})},function(){});return Promise.resolve(n&&n.then?n.then(t):t())}catch(e){return Promise.reject(e)}},this.updateMode=function(e){e!==r.mode&&(r.mode=e,r.options.onModeChange({mode:e}))},this.updateStatus=function(e){e!==r.status&&(r.status=e,r.options.onStatusChange({status:e}))},this.updateCanSendFeedback=function(){var e=r.currentEventId!==r.lastFeedbackEventId;r.canSendFeedback!==e&&(r.canSendFeedback=e,r.options.onCanSendFeedbackChange({canSendFeedback:e}))},this.onMessage=function(e){try{switch(e.type){case"interruption":return e.interruption_event&&(s.lastInterruptTimestamp=e.interruption_event.event_id),s.fadeOutAudio(),Promise.resolve();case"agent_response":return s.options.onMessage({source:"ai",message:e.agent_response_event.agent_response}),Promise.resolve();case"user_transcript":return s.options.onMessage({source:"user",message:e.user_transcription_event.user_transcript}),Promise.resolve();case"internal_tentative_agent_response":return s.options.onDebug({type:"tentative_agent_response",response:e.tentative_agent_response_internal_event.tentative_agent_response}),Promise.resolve();case"client_tool_call":return Promise.resolve(function(){if(s.options.clientTools.hasOwnProperty(e.client_tool_call.tool_name)){var t=c(function(){return Promise.resolve(s.options.clientTools[e.client_tool_call.tool_name](e.client_tool_call.parameters)).then(function(t){var n="object"==typeof t?JSON.stringify(t):String(t);s.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:n,is_error:!1})})},function(t){s.onError("Client tool execution failed with following error: "+(null==t?void 0:t.message),{clientToolName:e.client_tool_call.tool_name}),s.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:"Client tool execution failed: "+(null==t?void 0:t.message),is_error:!0})});if(t&&t.then)return t.then(function(){})}else{if(s.options.onUnhandledClientToolCall)return void s.options.onUnhandledClientToolCall(e.client_tool_call);s.onError("Client tool with name "+e.client_tool_call.tool_name+" is not defined on client",{clientToolName:e.client_tool_call.tool_name}),s.connection.sendMessage({type:"client_tool_result",tool_call_id:e.client_tool_call.tool_call_id,result:"Client tool with name "+e.client_tool_call.tool_name+" is not defined on client",is_error:!0})}}());case"audio":return s.lastInterruptTimestamp<=e.audio_event.event_id&&(s.options.onAudio(e.audio_event.audio_base_64),s.addAudioBase64Chunk(e.audio_event.audio_base_64),s.currentEventId=e.audio_event.event_id,s.updateCanSendFeedback(),s.updateMode("speaking")),Promise.resolve();case"ping":return s.connection.sendMessage({type:"pong",event_id:e.ping_event.event_id}),Promise.resolve();default:return s.options.onDebug(e),Promise.resolve()}}catch(e){return Promise.reject(e)}},this.onInputWorkletMessage=function(e){var t;"connected"===r.status&&r.connection.sendMessage({user_audio_chunk:(t=new Uint8Array(e.data[0].buffer),window.btoa(String.fromCharCode.apply(String,t)))})},this.onOutputWorkletMessage=function(e){var t=e.data;"process"===t.type&&r.updateMode(t.finished?"listening":"speaking")},this.addAudioBase64Chunk=function(e){r.output.gain.gain.value=r.volume,r.output.worklet.port.postMessage({type:"clearInterrupted"}),r.output.worklet.port.postMessage({type:"buffer",buffer:function(e){for(var t=window.atob(e),n=t.length,o=new Uint8Array(n),i=0;i<n;i++)o[i]=t.charCodeAt(i);return o.buffer}(e)})},this.fadeOutAudio=function(){r.updateMode("listening"),r.output.worklet.port.postMessage({type:"interrupt"}),r.output.gain.gain.exponentialRampToValueAtTime(1e-4,r.output.context.currentTime+2),setTimeout(function(){r.output.gain.gain.value=r.volume,r.output.worklet.port.postMessage({type:"clearInterrupted"})},2e3)},this.onError=function(e,t){console.error(e,t),r.options.onError(e,t)},this.calculateVolume=function(e){if(0===e.length)return 0;for(var t=0,n=0;n<e.length;n++)t+=e[n]/255;return(t/=e.length)<0?0:t>1?1:t},this.getId=function(){return r.connection.conversationId},this.isOpen=function(){return"connected"===r.status},this.setVolume=function(e){r.volume=e.volume},this.setMicMuted=function(e){r.input.setMuted(e)},this.getInputByteFrequencyData=function(){return null!=r.inputFrequencyData||(r.inputFrequencyData=new Uint8Array(r.input.analyser.frequencyBinCount)),r.input.analyser.getByteFrequencyData(r.inputFrequencyData),r.inputFrequencyData},this.getOutputByteFrequencyData=function(){return null!=r.outputFrequencyData||(r.outputFrequencyData=new Uint8Array(r.output.analyser.frequencyBinCount)),r.output.analyser.getByteFrequencyData(r.outputFrequencyData),r.outputFrequencyData},this.getInputVolume=function(){return r.calculateVolume(r.getInputByteFrequencyData())},this.getOutputVolume=function(){return r.calculateVolume(r.getOutputByteFrequencyData())},this.sendFeedback=function(e){r.canSendFeedback?(r.connection.sendMessage({type:"feedback",score:e?"like":"dislike",event_id:r.currentEventId}),r.lastFeedbackEventId=r.currentEventId,r.updateCanSendFeedback()):console.warn(0===r.lastFeedbackEventId?"Cannot send feedback: the conversation has not started yet.":"Cannot send feedback: feedback has already been sent for the current response.")},this.sendContextualUpdate=function(e){r.connection.sendMessage({type:"contextual_update",text:e})},this.options=e,this.connection=t,this.input=n,this.output=o,this.wakeLock=i,this.options.onConnect({conversationId:t.conversationId}),this.connection.onDisconnect(this.endSessionWithDetails),this.connection.onMessage(this.onMessage),this.input.worklet.port.onmessage=this.onInputWorkletMessage,this.output.worklet.port.onmessage=this.onOutputWorkletMessage,this.updateStatus("connected")}return t.startSession=function(n){try{var a=function(){return c(function(){return Promise.resolve(navigator.mediaDevices.getUserMedia({audio:!0})).then(function(a){function c(){return Promise.resolve(l.create(n)).then(function(o){return h=o,Promise.resolve(Promise.all([i.create(e({},h.inputFormat,{preferHeadphonesForIosDevices:n.preferHeadphonesForIosDevices})),r.create(h.outputFormat)])).then(function(e){var n;return u=e[0],g=e[1],null==(n=f)||n.getTracks().forEach(function(e){return e.stop()}),f=null,new t(s,h,u,g,p)})})}f=a;var d,m,v,y=null!=(m=n.connectionDelay)?m:{default:0,android:3e3},b=y.default;/android/i.test(navigator.userAgent)?b=null!=(v=y.android)?v:b:o()&&(b=null!=(d=y.ios)?d:b);var w=function(){if(b>0)return Promise.resolve(new Promise(function(e){return setTimeout(e,b)})).then(function(){})}();return w&&w.then?w.then(c):c()})},function(e){var t,n,o;return s.onStatusChange({status:"disconnected"}),null==(t=f)||t.getTracks().forEach(function(e){return e.stop()}),null==(n=h)||n.close(),Promise.resolve(null==(o=u)?void 0:o.close()).then(function(){var t;return Promise.resolve(null==(t=g)?void 0:t.close()).then(function(){function t(){throw e}var n=c(function(){var e;return Promise.resolve(null==(e=p)?void 0:e.release()).then(function(){p=null})},function(){});return n&&n.then?n.then(t):t()})})})},s=e({},d,m,n);s.onStatusChange({status:"connecting"}),s.onCanSendFeedbackChange({canSendFeedback:!1});var u=null,h=null,g=null,f=null,p=null,v=function(e){if(null==(e=n.useWakeLock)||e){var t=c(function(){return Promise.resolve(navigator.wakeLock.request("screen")).then(function(e){p=e})},function(){});if(t&&t.then)return t.then(function(){})}}();return Promise.resolve(v&&v.then?v.then(a):a())}catch(e){return Promise.reject(e)}},t}();class g{constructor(e={}){this.color=e.color||"#00ff80",this.shadowBlur=e.shadowBlur||16,this.lineWidth=e.lineWidth||3,this.backgroundImage=e.backgroundImage||null}setup(e){e&&this.backgroundImage&&(e.style.setProperty("--bg-image",`url('${this.backgroundImage}')`),e.classList.add("has-bg"),console.log("[LineVisualizer] Background image configured:",this.backgroundImage))}draw(e,t,n,o,i,a){if(!e||!t)return;let s=t.clientWidth,r=t.clientHeight;e.clearRect(0,0,s,r),e.beginPath(),e.lineWidth=this.lineWidth,e.strokeStyle=this.color,e.shadowColor=this.color,e.shadowBlur=this.shadowBlur;let l=Math.floor(r/2),u=0;if(n&&o){n.getByteTimeDomainData(o);let t=0;for(let e=0;e<o.length;e++)t+=o[e];t/=o.length;let i=s/o.length,a=0;for(let n=0;n<o.length;n++){let s=(o[n]-t)/128,u=n*i,c=l+.22*r*s;0===n?e.moveTo(u,c):e.lineTo(u,c),a+=s*s}u=Math.sqrt(a/o.length)}else if(i?.getOutputByteFrequencyData){try{let e=i.getOutputByteFrequencyData();e&&"function"==typeof e.then?e.then(e=>{a=e}).catch(()=>{}):e instanceof Uint8Array&&(a=e)}catch{}let t=a,n=t?.length||0;if(n>0){let o=0;for(let e=0;e<n;e++)o+=t[e];o/=n||1;let i=s/n,a=0;for(let s=0;s<n;s++){let n=(t[s]-o)/255,u=s*i,c=l+2*n*(.22*r);0===s?e.moveTo(u,c):e.lineTo(u,c),a+=n*n}u=Math.sqrt(a/n)/1.1}}return e.stroke(),{rms:u}}drawIdle(e,t,n){if(!e||!t)return;let o=t.clientWidth,i=t.clientHeight;e.clearRect(0,0,o,i);let a=.12*Math.min(o,i)*(1+.06*Math.sin(2*n*Math.PI*.9));e.shadowColor=this.color,e.shadowBlur=20,e.strokeStyle=this.color,e.lineWidth=this.lineWidth,e.beginPath(),e.arc(o/2,i/2,a,0,2*Math.PI),e.stroke()}}const f={line:g,image:class{constructor(e={}){console.log("[ImageVisualizer] Constructor called with config:",e),this.mode="image",this.interval=e.interval||200,this.talkImages=e.talk_images||[],this.idleImages=e.idle_images||[],this.backgroundColor=e.backgroundColor||"#000000",console.log("[ImageVisualizer] Talk images:",this.talkImages),console.log("[ImageVisualizer] Idle images:",this.idleImages),this.talkImageElements=[],this.idleImageElements=[],this.imagesLoaded=!1,this.loadingPromise=null,this.currentTalkFrame=0,this.lastFrameTime=0,this.currentIdleImage=null,this.preloadImages()}setup(e){e&&(e.style.backgroundColor=this.backgroundColor,console.log("[ImageVisualizer] Background color configured:",this.backgroundColor),e.classList.remove("has-bg"),e.style.removeProperty("--bg-image"))}async preloadImages(){return this.loadingPromise||(this.loadingPromise=new Promise(async e=>{let t=e=>new Promise((t,n)=>{let o=new Image;o.onload=()=>t(o),o.onerror=()=>{console.warn(`[ImageVisualizer] Failed to load image: ${e}`),n(Error(`Failed to load ${e}`))},o.src=e});try{console.log("[ImageVisualizer] Preloading talk images:",this.talkImages);let n=this.talkImages.map(e=>t(e).catch(()=>null));this.talkImageElements=(await Promise.all(n)).filter(e=>null!==e),console.log("[ImageVisualizer] Preloading idle images:",this.idleImages);let o=this.idleImages.map(e=>t(e).catch(()=>null));this.idleImageElements=(await Promise.all(o)).filter(e=>null!==e),this.imagesLoaded=!0,console.log("[ImageVisualizer] All images preloaded successfully"),console.log(`  - Talk images: ${this.talkImageElements.length}`),console.log(`  - Idle images: ${this.idleImageElements.length}`),this.idleImageElements.length>0&&(this.currentIdleImage=this.idleImageElements[Math.floor(Math.random()*this.idleImageElements.length)]),e()}catch(t){console.error("[ImageVisualizer] Error preloading images:",t),this.imagesLoaded=!0,e()}})),this.loadingPromise}drawImage(e,t,n){let o,i,a,s;if(!e||!t||!n)return;let r=t.clientWidth,l=t.clientHeight;e.clearRect(0,0,r,l);let u=n.width/n.height;u>r/l?(o=r,a=0,s=(l-(i=r/u))/2):(i=l,a=(r-(o=l*u))/2,s=0),e.drawImage(n,a,s,o,i)}draw(e,t,n,o,i,a){if(!this.imagesLoaded||0===this.talkImageElements.length)return this.drawPlaceholder(e,t,"Loading...","#00ff80"),{rms:0};let s=performance.now();s-this.lastFrameTime>=this.interval&&(this.currentTalkFrame=(this.currentTalkFrame+1)%this.talkImageElements.length,this.lastFrameTime=s);let r=this.talkImageElements[this.currentTalkFrame];return this.drawImage(e,t,r),{rms:.5}}drawIdle(e,t,n){return this.imagesLoaded?0===this.idleImageElements.length?void this.drawPlaceholder(e,t,"Idle","#00ff80"):void(this.currentIdleImage&&this.drawImage(e,t,this.currentIdleImage)):void this.drawPlaceholder(e,t,"Loading...","#00ff80")}drawPlaceholder(e,t,n,o){if(!e||!t)return;let i=t.clientWidth,a=t.clientHeight;e.clearRect(0,0,i,a),e.fillStyle=o,e.font="24px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText(n,i/2,a/2)}changeIdleImage(){this.idleImageElements.length>0&&(this.currentIdleImage=this.idleImageElements[Math.floor(Math.random()*this.idleImageElements.length)])}resetTalkAnimation(){this.currentTalkFrame=0,this.lastFrameTime=performance.now()}}};function p(e,t){let n=f[e];return n?new n(t):(console.warn(`[viz] Unknown visualizer mode: ${e}, falling back to 'line'`),new g(t))}let v=null,y=null,b=null,w=null,k=null,I=null,x="idle",_=null;const M=new WeakMap,S=new WeakMap,C=new Set;let E=null,P=null,z={mode:"line",color:"#00ff80"},L=null,F=!1,A=0;const T=async()=>{if(v||(v=new(window.AudioContext||window.webkitAudioContext)),"suspended"===v.state)try{await v.resume()}catch{}},D=e=>{e!==x&&(console.log("[viz] state ->",e),x=e)},B=(e,t=null)=>{e&&(console.log("[viz] config updated:",z={...z,...e}),P=p(z.mode||"line",z),t&&(L=t),P&&"function"==typeof P.setup&&L&&P.setup(L))},q=e=>{if(y=v&&v.createAnalyser?v.createAnalyser():null){y.fftSize=2048,b=new Uint8Array(y.frequencyBinCount);try{e.disconnect()}catch{}e.connect(y),_||((_=v.createGain()).gain.value=0,_.connect(v.destination));try{y.disconnect()}catch{}y.connect(_)}},R=async e=>{if(!(e instanceof HTMLMediaElement))return;await T();let t=M.get(e);if(!t){try{t=v.createMediaElementSource(e)}catch(e){console.warn("[viz] createMediaElementSource failed",e)}t&&M.set(e,t)}t&&q(t);try{e.crossOrigin="anonymous"}catch{}console.log("[viz] MediaElement connected",{src:e.currentSrc||e.src}),e.addEventListener("play",()=>{C.add(e),D("active"),console.log("[viz] element play")});let n=()=>{C.delete(e),0===C.size&&D("idle"),console.log("[viz] element stop/pause, playing count:",C.size)};e.addEventListener("pause",n),e.addEventListener("ended",n)},W=async e=>{if(!(e instanceof MediaStream))return;await T();let t=S.get(e);if(!t){try{t=v.createMediaStreamSource(e)}catch(e){console.warn("[viz] createMediaStreamSource failed",e)}t&&S.set(e,t)}t&&q(t),D("active"),console.log("[viz] MediaStream connected with tracks:",e.getTracks().map(e=>e.kind+":"+e.readyState)),e.getTracks().forEach(t=>t.addEventListener("ended",()=>{e.getTracks().every(e=>"ended"===e.readyState)&&(D("idle"),console.log("[viz] stream ended"))}))},j=()=>{let e=async(e,t)=>{t instanceof HTMLMediaElement&&("play"===e?(await R(t),C.add(t),D("active"),console.log("[viz] global play",t.tagName)):(C.delete(t),0===C.size&&D("idle"),console.log("[viz] global",e,"playing count:",C.size)))};document.addEventListener("play",t=>e("play",t.target),!0),document.addEventListener("pause",t=>e("pause",t.target),!0),document.addEventListener("ended",t=>e("ended",t.target),!0)},O=async e=>{try{if(!e)return;let t=e.audioElement||e.audioEl||e.audio;if(t instanceof HTMLMediaElement)return void await R(t);let n=e.mediaStream||e.outputStream||e.remoteStream||e.stream;if(n instanceof MediaStream)return void await W(n);new MutationObserver(e=>{e.forEach(e=>{e.addedNodes?.forEach(e=>{e instanceof HTMLMediaElement&&R(e),e.querySelectorAll&&e.querySelectorAll("audio,video").forEach(R)})})}).observe(document.documentElement,{childList:!0,subtree:!0})}catch(e){console.warn("[viz] hookConversationAudio failed",e)}},U=e=>{E=e},V=e=>{if(!(k=document.getElementById(e)))return;I=k.getContext("2d");let t=()=>{let e=window.devicePixelRatio||1,t=k.clientWidth||window.innerWidth,n=k.clientHeight||window.innerHeight;k.width=Math.floor(t*e),k.height=Math.floor(n*e),I.setTransform(e,0,0,e,0,0)};t(),window.addEventListener("resize",t)},$=e=>{P&&P.drawIdle(I,k,e)},N=()=>{if(!P)return;let e=P.draw(I,k,y,b,E,null),t=e?.rms||0,n=t>.015;n&&!F&&console.log("[viz] audio signal detected, rms=",t.toFixed(3)),n?A=0:(A++,F&&A>20&&console.log("[viz] audio gone silent")),F=n},H=(e="vizCanvas",t=null,n=null)=>{n&&(L=n),t?B(t,L):!P&&(P=p(z.mode,z))&&"function"==typeof P.setup&&L&&P.setup(L),V(e),cancelAnimationFrame(w);let o=e=>{"active"===x||"line"===x?N():$(e/1e3),w=requestAnimationFrame(o)};w=requestAnimationFrame(o)};let J=null,G=[],X=[],K=[],Q=!1,Y=null,Z=null;const ee={enabled:!0,wordsPerSecond:3,fadeOutDelay:2e3,maxLines:2,maxCharsPerLine:40,blockDuration:3e3,position:"bottom",fontSize:"2rem",fontFamily:"system-ui, -apple-system, sans-serif",color:"#ffffff",backgroundColor:"rgba(0, 0, 0, 0.7)",textAlign:"center",padding:"1rem 2rem",maxWidth:"80%"};let et={...ee};const en=e=>{let t=window.innerWidth,n=t<=768,o=t<=480,i={...e},a=e.fontSize.match(/^([\d.]+)(rem|px|em)$/);if(a){let[,t,s]=a,r=parseFloat(t);o?(r*=.5,i.maxCharsPerLine=Math.floor(.6*e.maxCharsPerLine),i.padding="0.5rem 1rem"):n&&(r*=.65,i.maxCharsPerLine=Math.floor(.75*e.maxCharsPerLine),i.padding="0.75rem 1.5rem"),i.fontSize=`${r}${s}`}return console.log("[subtitle] Responsive adjustments:",{screenWidth:t,isMobile:n,isSmallMobile:o,originalFontSize:e.fontSize,adjustedFontSize:i.fontSize,originalMaxChars:e.maxCharsPerLine,adjustedMaxChars:i.maxCharsPerLine}),i},eo=(e,t={})=>{let n;if(et=en({...ee,...t}),!e)return void console.error("[subtitle] Container element not found");(J=e.querySelector(".subtitle-container"))||((J=document.createElement("div")).className="subtitle-container",ei(),e.appendChild(J)),window.addEventListener("resize",()=>{clearTimeout(n),n=setTimeout(()=>{et=en({...ee,...t}),ei(),console.log("[subtitle] Config updated after resize")},250)}),console.log("[subtitle] Initialized with config:",et)},ei=()=>{if(!J)return;let e={bottom:{bottom:"5%",top:"auto",transform:"translateX(-50%)"},top:{top:"5%",bottom:"auto",transform:"translateX(-50%)"},center:{top:"50%",bottom:"auto",transform:"translate(-50%, -50%)"}},t=e[et.position]||e.bottom;Object.assign(J.style,{position:"absolute",left:"50%",...t,maxWidth:et.maxWidth,width:"auto",padding:et.padding,backgroundColor:et.backgroundColor,color:et.color,fontSize:et.fontSize,fontFamily:et.fontFamily,textAlign:et.textAlign,borderRadius:"0.5rem",pointerEvents:"none",zIndex:"1000",opacity:"0",transition:"opacity 0.3s ease-in-out",wordWrap:"break-word",lineHeight:"1.4",textShadow:"2px 2px 4px rgba(0, 0, 0, 0.8)"})},ea=e=>{if(et.enabled&&J){if(console.log("[subtitle] Message received:",e),"user"===e.source||"user"===e.role||"user"===e.from)return void console.log("[subtitle] Ignoring user message");"conversation_initiation_metadata"===e.type?console.log("[subtitle] Conversation started"):"audio"===e.type||"message"===e.type?("ai"===e.source||"agent"===e.source||"assistant"===e.role||!e.source)&&(e.transcript||e.text)&&er(e.transcript||e.text):e.message&&("ai"===e.source||"agent"===e.source||!e.source)&&er(e.message)}},es=e=>{let t=e.trim().split(/\s+/),n=[],o=et.maxCharsPerLine*et.maxLines,i=[],a=0;for(let e of t){let t=e.length+1,s=/[.!?]$/.test(e);a+t>o&&i.length>0?(n.push(i.join(" ")),i=[e],a=t):(i.push(e),a+=t,s&&a>=.5*et.maxCharsPerLine&&(n.push(i.join(" ")),i=[],a=0))}return i.length>0&&n.push(i.join(" ")),n},er=e=>{e&&J&&(console.log("[subtitle] Displaying:",e),eu(),console.log("[subtitle] Blocks:",G=es(e)),el())},el=()=>{if(0===G.length)return void ec();let e=G.shift();X=e.split(/\s+/),K=[],console.log("[subtitle] Showing block:",e),J.textContent="",J.style.opacity="1",Q=!0;let t=1e3/et.wordsPerSecond;Y=setInterval(()=>{if(0===X.length){clearInterval(Y),Y=null,Q=!1;let e=K.length,n=K.join(" "),o=et.maxCharsPerLine*et.maxLines,i=Math.min(1,n.length/o),a=500+(et.blockDuration-500)*i,s=Math.max(0,a-e*t);console.log("[subtitle] Block stats:",{words:e,chars:n.length,fillRatio:i.toFixed(2),pauseDuration:Math.round(a),remainingTime:Math.round(s)}),Z&&clearTimeout(Z),Z=setTimeout(()=>{G.length>0?el():ec()},s);return}let e=X.shift();K.push(e),J.textContent=K.join(" ")},t)},eu=()=>{Y&&(clearInterval(Y),Y=null),Z&&(clearTimeout(Z),Z=null),Q=!1,G=[],X=[],K=[]},ec=()=>{setTimeout(()=>{J&&!Q&&(J.style.opacity="0",setTimeout(()=>{J&&!Q&&(J.textContent="")},300))},et.fadeOutDelay)},ed=()=>{eu(),J&&(J.style.opacity="0",setTimeout(()=>{J&&(J.textContent="")},300))},em=document.getElementById("startBtn"),eh=document.getElementById("stopBtn"),eg=document.getElementById("status");let ef=null,ep=null,ev=!1;const ey=new URLSearchParams(window.location.search);let eb={name:ey.get("name"),agentId:ey.get("id"),mode:ey.get("mode")||"card",visualizationMode:ey.get("visualization")||null,subtitlesEnabled:null!==ey.get("subtitles")?"true"===ey.get("subtitles")||"1"===ey.get("subtitles"):null};console.log("Initial config from URL params:",eb);const ew=()=>{if(!eb.visualizations||"object"!=typeof eb.visualizations)return"Erro: Configuração de visualizações não encontrada no JSON do agente.";let e=eb.visualizationMode||eb.defaultVisualization;if(!e)return"Erro: Nenhum modo de visualização especificado. Use o parâmetro ?visualization=<modo> na URL.";if(!eb.visualizations[e]){let t=Object.keys(eb.visualizations).join(", ");return`Erro: Visualiza\xe7\xe3o "${e}" n\xe3o encontrada. Modos dispon\xedveis: ${t}`}let t=eb.visualizations[e];if(!t.mode)return`Erro: Par\xe2metro "mode" ausente na configura\xe7\xe3o da visualiza\xe7\xe3o "${e}".`;if("image"===t.mode){if(!t.talk_images||!Array.isArray(t.talk_images)||0===t.talk_images.length)return`Erro: Par\xe2metro "talk_images" ausente ou inv\xe1lido na visualiza\xe7\xe3o "${e}".`;if(!t.idle_images||!Array.isArray(t.idle_images)||0===t.idle_images.length)return`Erro: Par\xe2metro "idle_images" ausente ou inv\xe1lido na visualiza\xe7\xe3o "${e}".`}return null},ek=e=>{let t=document.getElementById("card"),n=document.getElementById("fullMode");t&&t.classList.add("hidden"),n&&n.classList.add("hidden");let o=document.createElement("div");o.className="fixed inset-0 bg-red-900 flex items-center justify-center p-8",o.innerHTML=`
    <div class="bg-white rounded-lg shadow-2xl p-8 max-w-2xl">
      <h1 class="text-3xl font-bold text-red-600 mb-4">\u{26A0}\u{FE0F} Erro de Configura\xe7\xe3o</h1>
      <p class="text-gray-800 text-lg mb-6">${e}</p>
      <div class="text-sm text-gray-600">
        <p class="mb-2"><strong>Dicas:</strong></p>
        <ul class="list-disc list-inside space-y-1">
          <li>Verifique se o JSON do agente possui o objeto "visualizations"</li>
          <li>Use ?visualization=<modo> na URL para especificar o modo</li>
          <li>Certifique-se de que todos os par\xe2metros necess\xe1rios est\xe3o configurados</li>
        </ul>
      </div>
    </div>
  `,document.body.appendChild(o)},eI=()=>{let e=document.getElementById("card"),t=document.getElementById("fullMode");if("fullscreen"===eb.mode){console.log("[fullscreen] Initializing fullscreen mode"),e&&e.classList.add("hidden"),t&&t.classList.remove("hidden");let n=eb.visualizationMode||eb.defaultVisualization,o=eb.visualizations[n];console.log("[fullscreen] Using visualization mode:",n),console.log("[fullscreen] Visualizer config:",o),"line"===o.mode&&eb.backgroundImage&&(o.backgroundImage=eb.backgroundImage),H("vizCanvas",o,t),j();let i=eb.subtitles||{};!1!==i.enabled?(eo(t,i),console.log("[fullscreen] Subtitles initialized")):console.log("[fullscreen] Subtitles disabled"),t.addEventListener("click",async()=>{ef?await eS():await eM()}),D("idle")}},ex=()=>{let e=document.getElementById("card"),t=document.getElementById("painelMode");if("painel"===eb.mode){console.log("[painel] Initializing painel mode (384x768)"),e&&e.classList.add("hidden"),t&&t.classList.remove("hidden");let n=eb.visualizationMode||eb.defaultVisualization,o=eb.visualizations[n];console.log("[painel] Using visualization mode:",n),console.log("[painel] Visualizer config:",o),"line"===o.mode&&eb.backgroundImage&&(o.backgroundImage=eb.backgroundImage),H("painelCanvas",o,t),j();let i=eb.subtitles||{};!1!==i.enabled?(eo(t,i),console.log("[painel] Subtitles initialized")):console.log("[painel] Subtitles disabled"),t.addEventListener("click",async()=>{ef?await eS():await eM()}),D("idle")}};(async()=>{let e=ey.get("mode")||"card",t=ey.get("visualization"),n=eb.subtitlesEnabled;if(!eb.agentId)try{let o=await fetch(`./agents/${eb.name}.json`);if(!o.ok)throw Error(`HTTP ${o.status}: ${o.statusText}`);let i=await o.json();eb={...i,mode:e,visualizationMode:t||i.defaultVisualization},null!==n&&eb.subtitles&&(eb.subtitles.enabled=n),console.log("Config loaded and merged:",eb)}catch(e){console.error("Error loading config:",e)}if(document.getElementById("name").textContent=eb.name,!eb.agentId){let e=document.getElementById("startBtn");e.disabled=!0,e.innerText="Agente não encontrado!"}if("fullscreen"===eb.mode||"painel"===eb.mode){let e=ew();if(e)return ek(e)}"painel"===eb.mode?ex():"fullscreen"===eb.mode&&eI()})();const e_=e=>{eg.textContent="Status: "+e};async function eM(){if(ev||ef)return void console.log("[startConversation] Already starting or active, ignoring...");ev=!0;try{if(await navigator.mediaDevices.getUserMedia({audio:!0}),e_("Microfone liberado"),eb.startAudio){em.classList.add("hidden"),eh.classList.remove("hidden"),ep=new Audio(eb.startAudio);try{ep.crossOrigin="anonymous"}catch{}("fullscreen"===eb.mode||"painel"===eb.mode)&&(await R(ep),D("active")),ep.play(),e_("Reproduzindo áudio de boas-vindas"),await new Promise(e=>{ep.onended=()=>{("fullscreen"===eb.mode||"painel"===eb.mode)&&D("idle"),e()}})}ef=await h.startSession({agentId:eb.agentId,onConnect:()=>{console.log("Conectado ao agente!"),e_("Conectado")},onDisconnect:()=>{console.log("Conexão encerrada."),e_("Desconectado")},onMessage:e=>{console.log("Mensagem recebida:",e),eb.subtitles&&!1===eb.subtitles.enabled||ea(e)},onError:e=>{console.error("Erro na sessão:",e),e_("Erro")},onStatusChange:e=>{console.log("Status alterado:",e)},onModeChange:e=>{console.log("Modo alterado:",e);try{("fullscreen"===eb.mode||"painel"===eb.mode)&&("speaking"==e.mode?(D("active"),console.log("[viz] speaking!!!")):(D("idle"),console.log("[viz] idle!")))}catch{}}}),("fullscreen"===eb.mode||"painel"===eb.mode)&&(await O(ef),U(ef)),ev=!1}catch(e){console.error("Erro ao iniciar a conversa:",e),e_("Erro ao iniciar"),ev=!1}}async function eS(){ep&&(ep.pause(),ep=null),ed(),D("idle"),ef&&(await ef.endSession(),ef=null),ev=!1,e_("Desconectado"),em.classList.remove("hidden"),eh.classList.add("hidden")}em.addEventListener("click",eM),eh.addEventListener("click",eS);
//# sourceMappingURL=arapy-11labs.64784b22.js.map
